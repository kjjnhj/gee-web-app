<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>鄱阳湖水体分析系统</title>
  
  <!-- 引入Google Identity Services库 -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- 其他样式和库保持不变 -->
</head>
<body>
  <!-- 您的页面内容保持不变 -->

  <script>
    // 配置GEE认证
    const GEE_CLIENT_ID = '43779976395-dm7nk4h1k9vdqpkpe7mmn4nr3k2easdq.apps.googleusercontent.com';
    
    // 初始化GEE认证
    async function initializeGEEAuth() {
      return new Promise((resolve, reject) => {
        if (typeof google === 'undefined' || !google.accounts) {
          reject(new Error('Google Identity Services库未加载'));
          return;
        }
        
        // 配置Token Client
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GEE_CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/earthengine',
          callback: (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) {
              // 设置GEE认证令牌
              ee.data.setAuthToken(
                'auth_token',
                'oauth2', 
                tokenResponse.access_token,
                3600, // 1小时有效期
                [], 
                false
              );
              resolve();
            } else {
              reject(new Error('用户未完成授权或授权失败'));
            }
          },
          error_callback: (error) => {
            reject(new Error(`认证错误: ${error.message}`));
          }
        });
        
        // 请求访问令牌
        tokenClient.requestAccessToken({prompt: 'consent'});
      });
    }

    // 初始化GEE
    async function initializeGEE() {
      try {
        // 先进行认证
        await initializeGEEAuth();
        
        // 然后初始化EE
        return new Promise((resolve, reject) => {
          ee.initialize(
            null,
            null,
            () => resolve(),
            (error) => reject(error)
          );
        });
      } catch (error) {
        throw new Error(`GEE初始化失败: ${error.message}`);
      }
    }

    // 在您的initApp函数中使用
    async function initApp() {
      try {
        // ...其他初始化代码...
        
        // 初始化GEE
        await initializeGEE();
        
        // ...剩余代码...
      } catch (error) {
        console.error('初始化错误:', error);
        // 显示错误和重试按钮
      }
    }
  </script>
</body>
</html>
